<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>My Google Map</title>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJ0Uhc26h5_g8fYI57KXPEemFc33v0GXc&callback=initMap"></script>
  <script defer src="main.js"> </script>

  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div id="map">

  </div>

  <script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyDCcNAWv3tggQHNt1QN3-X-vjB_uQBC3R8",
      authDomain: "iot-gps-for-sau.firebaseapp.com",
      databaseURL: "https://iot-gps-for-sau.firebaseio.com",
      projectId: "iot-gps-for-sau",
      storageBucket: "iot-gps-for-sau.appspot.com",
      messagingSenderId: "195237350046"
    };
    firebase.initializeApp(config);

    // Get a reference to the auth service
    var auth = firebase.auth();
    /**
    * Data object to be written to Firebase.
    */
    var data = {
      timestamp: 148420310123,
      lat: 40.6940,
      lng: 30.4358
    };

    firebase.auth().signInAnonymously().catch(function(error) {
      // Handle Errors here.
      var errorCode = error.code;
      var errorMessage = error.message;
      // ...
    });

    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        var isAnonymous = user.isAnonymous;
        var uid = user.uid;
        console.log("[info] User has been logged in: " + uid);
        data.sender = uid;

        writeUserData(data);
        getUserData(1);

        // ...
      } else {
        // User is signed out.
        // ...
      }
      // ...
    });

    function getUserData(postId){
      var databaseRef = firebase.database().ref();
      databaseRef.on('value', function(snapshot) {
        var data = JSON.stringify(snapshot.val());
        var user01 = JSON.parse(data);

        console.log(JSON.stringify(data));
      });
      console.log("[info] User data has been got!");
    }

    function writeUserData(data) {
      console.log("[info] " + JSON.stringify(data) + " will write!");

      // Get a reference to the database service
      var databaseRef = firebase.database().ref();
      var locationsRef = databaseRef.child('app/locations/' + data.sender);
      var newDataRef = locationsRef.push();
      newDataRef.set({
        timestamp: data.timestamp,
        lat: data.lat,
        lng: data.lng
      });
      console.log("[info] Data has been written!");
    }
  </script>
</body>
</html>
